"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getInput = getInput;
exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = require("react");

var _form = require("./form.validation");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var FormAction;

(function (FormAction) {
  FormAction["INPUT_CHANGE"] = "INPUT_CHANGE";
  FormAction["INPUT_TOUCH"] = "INPUT_TOUCH";
  FormAction["SET_FORM"] = "SET_FORM";
})(FormAction || (FormAction = {}));

function getInput(initialValue, options) {
  var parsedOptions = {
    isValid: false,
    isTouched: false,
    validators: [],
    connectedFields: (options === null || options === void 0 ? void 0 : options.connectFields) || []
  };

  if (typeof options !== 'undefined') {
    var keys = Object.keys(options);
    parsedOptions.isTouched = !!options.isTouched;
    parsedOptions.isValid = !!options.isValid;
    keys.forEach(function (key) {
      if (!(key in ['isValid', 'isTouched', 'connectedFields'])) {
        parsedOptions.validators.push((0, _form.getValidator)(key, options[key]));
      }
    });
  }

  return _objectSpread(_objectSpread({}, parsedOptions), {}, {
    value: initialValue
  });
}

var handleConnectedFields = function handleConnectedFields(state, targetId) {
  try {
    var newInputState = _objectSpread({}, state.inputs);

    newInputState[targetId].connectedFields.forEach(function (connectedFieldId) {
      if (typeof newInputState[connectedFieldId] !== 'undefined') {
        newInputState[connectedFieldId] = _objectSpread(_objectSpread({}, newInputState[connectedFieldId]), {}, {
          isValid: (0, _form.validate)(newInputState[connectedFieldId].value, newInputState[connectedFieldId].validators, state)
        });
      }
    });
    return newInputState;
  } catch (err) {
    process.env.NODE_ENV !== 'production' && console.error(err);
    return state.inputs;
  }
};

function formReducer(state, action) {
  var pl = action.payload;

  switch (action.type) {
    case FormAction.INPUT_CHANGE:
      var newState = _objectSpread(_objectSpread({}, state), {}, {
        inputs: _objectSpread(_objectSpread({}, state.inputs), {}, (0, _defineProperty2["default"])({}, pl.id, _objectSpread(_objectSpread({}, state.inputs[pl.id]), {}, {
          value: pl.value,
          isValid: (0, _form.validate)(pl.value, state.inputs[pl.id].validators, state)
        })))
      });

      newState.inputs = _objectSpread(_objectSpread({}, newState.inputs), handleConnectedFields(_objectSpread({}, newState), pl.id));
      var isValid = true;

      for (var _key in newState.inputs) {
        isValid = isValid && newState.inputs[_key].isValid;
      }

      return _objectSpread(_objectSpread({}, newState), {}, {
        inputs: _objectSpread({}, newState.inputs),
        isValid: isValid
      });

    case FormAction.INPUT_TOUCH:
      return _objectSpread(_objectSpread({}, state), {}, {
        inputs: _objectSpread(_objectSpread({}, state.inputs), {}, (0, _defineProperty2["default"])({}, pl.id, _objectSpread(_objectSpread({}, state.inputs[pl.id]), {}, {
          isTouched: true
        })))
      });

    case FormAction.SET_FORM:
      if (typeof pl.state !== 'undefined') {
        return _objectSpread({}, pl.state);
      } else {
        return state;
      }

    default:
      return state;
  }
}

function useFormState(initialState) {
  var _useReducer = (0, _react.useReducer)(formReducer, _objectSpread({}, initialState)),
      _useReducer2 = (0, _slicedToArray2["default"])(_useReducer, 2),
      formState = _useReducer2[0],
      dispatch = _useReducer2[1];

  var setFormState = (0, _react.useCallback)(function (state) {
    dispatch({
      type: FormAction.SET_FORM,
      payload: {
        state: state,
        value: '',
        id: ''
      }
    });
  }, []);
  var onTouchHandler = (0, _react.useCallback)(function (event) {
    dispatch({
      type: FormAction.INPUT_TOUCH,
      payload: {
        id: event.target.id,
        value: ''
      }
    });
  }, []);
  var onChangeHandler = (0, _react.useCallback)(function (event) {
    dispatch({
      type: FormAction.INPUT_CHANGE,
      payload: {
        id: event.target.id,
        value: event.target.value
      }
    });
  }, []);
  return {
    formState: formState,
    onChangeHandler: onChangeHandler,
    onTouchHandler: onTouchHandler,
    setFormState: setFormState
  };
}

var _default = useFormState;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9mb3JtLmhvb2sudHMiXSwibmFtZXMiOlsiRm9ybUFjdGlvbiIsImdldElucHV0IiwiaW5pdGlhbFZhbHVlIiwib3B0aW9ucyIsInBhcnNlZE9wdGlvbnMiLCJpc1ZhbGlkIiwiaXNUb3VjaGVkIiwidmFsaWRhdG9ycyIsImNvbm5lY3RlZEZpZWxkcyIsImNvbm5lY3RGaWVsZHMiLCJrZXlzIiwiT2JqZWN0IiwiZm9yRWFjaCIsImtleSIsInB1c2giLCJ2YWx1ZSIsImhhbmRsZUNvbm5lY3RlZEZpZWxkcyIsInN0YXRlIiwidGFyZ2V0SWQiLCJuZXdJbnB1dFN0YXRlIiwiaW5wdXRzIiwiY29ubmVjdGVkRmllbGRJZCIsImVyciIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImNvbnNvbGUiLCJlcnJvciIsImZvcm1SZWR1Y2VyIiwiYWN0aW9uIiwicGwiLCJwYXlsb2FkIiwidHlwZSIsIklOUFVUX0NIQU5HRSIsIm5ld1N0YXRlIiwiaWQiLCJJTlBVVF9UT1VDSCIsIlNFVF9GT1JNIiwidXNlRm9ybVN0YXRlIiwiaW5pdGlhbFN0YXRlIiwiZm9ybVN0YXRlIiwiZGlzcGF0Y2giLCJzZXRGb3JtU3RhdGUiLCJvblRvdWNoSGFuZGxlciIsImV2ZW50IiwidGFyZ2V0Iiwib25DaGFuZ2VIYW5kbGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOzs7Ozs7SUFFS0EsVTs7V0FBQUEsVTtBQUFBQSxFQUFBQSxVO0FBQUFBLEVBQUFBLFU7QUFBQUEsRUFBQUEsVTtHQUFBQSxVLEtBQUFBLFU7O0FBaURFLFNBQVNDLFFBQVQsQ0FDSEMsWUFERyxFQUVIQyxPQUZHLEVBR2M7QUFDakIsTUFBTUMsYUFBa0csR0FBRztBQUN2R0MsSUFBQUEsT0FBTyxFQUFFLEtBRDhGO0FBRXZHQyxJQUFBQSxTQUFTLEVBQUUsS0FGNEY7QUFHdkdDLElBQUFBLFVBQVUsRUFBRSxFQUgyRjtBQUl2R0MsSUFBQUEsZUFBZSxFQUFFLENBQUFMLE9B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QUFLLEVBQUxBLEtBQUY7QUFBU0YsUUFBQUEsS0FBSyxFQUFFLEVBQWhCO0FBQW9Cb0IsUUFBQUEsRUFBRSxFQUFFO0FBQXhCO0FBQXRDLEtBQUQsQ0FBUjtBQUNILEdBRm9CLEVBRWxCLEVBRmtCLENBQXJCO0FBSUEsTUFBTVEsY0FBMEMsR0FBRyx3QkFBWSxVQUFDQyxLQUFELEVBQVc7QUFDdEVILElBQUFBLFFBQVEsQ0FBQztBQUFFVCxNQUFBQSxJQUFJLEVBQUVoQyxVQUFVLENBQUNvQyxXQUFuQjtBQUFnQ0wsTUFBQUEsT0FBTyxFQUFFO0FBQUVJLFFBQUFBLEVBQUUsRUFBRVMsS0FBSyxDQUFDQyxNQUFOLENBQWFWLEVBQW5CO0FBQXVCcEIsUUFBQUEsS0FBSyxFQUFFO0FBQTlCO0FBQXpDLEtBQUQsQ0FBUjtBQUNILEdBRmtELEVBRWhELEVBRmdELENBQW5EO0FBSUEsTUFBTStCLGVBQTRDLEdBQUcsd0JBQVksVUFBQ0YsS0FBRCxFQUFXO0FBQ3hFSCxJQUFBQSxRQUFRLENBQUM7QUFDTFQsTUFBQUEsSUFBSSxFQUFFaEMsVUFBVSxDQUFDaUMsWUFEWjtBQUVMRixNQUFBQSxPQUFPLEVBQUU7QUFDTEksUUFBQUEsRUFBRSxFQUFFUyxLQUFLLENBQUNDLE1BQU4sQ0FBYVYsRUFEWjtBQUVMcEIsUUFBQUEsS0FBSyxFQUFFNkIsS0FBSyxDQUFDQyxNQUFOLENBQWE5QjtBQUZmO0FBRkosS0FBRCxDQUFSO0FBT0gsR0FSb0QsRUFRbEQsRUFSa0QsQ0FBckQ7QUFVQSxTQUFPO0FBQUV5QixJQUFBQSxTQUFTLEVBQVRBLFNBQUY7QUFBYU0sSUFBQUEsZUFBZSxFQUFmQSxlQUFiO0FBQThCSCxJQUFBQSxjQUFjLEVBQWRBLGNBQTlCO0FBQThDRCxJQUFBQSxZQUFZLEVBQVpBO0FBQTlDLEdBQVA7QUFDSDs7ZUFFY0osWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVzZVJlZHVjZXIsIHVzZUNhbGxiYWNrLCBSZWR1Y2VyIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgeyBWYWxpZGF0b3IsIFZhbGlkYXRpb25UeXBlLCBDdXN0b21WYWxpZGF0aW9uUnVsZSwgZ2V0VmFsaWRhdG9yLCB2YWxpZGF0ZSB9IGZyb20gJy4vZm9ybS52YWxpZGF0aW9uJztcblxuZW51bSBGb3JtQWN0aW9uIHtcbiAgICBJTlBVVF9DSEFOR0UgPSAnSU5QVVRfQ0hBTkdFJyxcbiAgICBJTlBVVF9UT1VDSCA9ICdJTlBVVF9UT1VDSCcsXG4gICAgU0VUX0ZPUk0gPSAnU0VUX0ZPUk0nXG59XG5cbnR5cGUgRm9ybUVsZW1lbnRDb25zdHJhaW50ID0gSFRNTElucHV0RWxlbWVudCB8IEhUTUxUZXh0QXJlYUVsZW1lbnQgfCBIVE1MU2VsZWN0RWxlbWVudDtcblxudHlwZSBSZWR1Y2VyQWN0aW9uID0geyB0eXBlOiBGb3JtQWN0aW9uOyBwYXlsb2FkOiBGb3JtUGF5bG9hZCB9O1xuXG50eXBlIEdldElucHV0T3B0aW9uczxUIGV4dGVuZHMgRm9ybVZhbHVlVHlwZSwgUyBleHRlbmRzIEZvcm1TdGF0ZUNvbnN0cmFpbnQgPSBhbnk+ID0ge1xuICAgIFtrZXk6IHN0cmluZ106IFQgfCBudW1iZXIgfCBib29sZWFuIHwgQ3VzdG9tVmFsaWRhdGlvblJ1bGU8VCwgUz4gfCBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgICBtaW5MZW5ndGg/OiBudW1iZXI7XG4gICAgbWF4TGVuZ3RoPzogbnVtYmVyO1xuICAgIG1pblZhbHVlPzogbnVtYmVyO1xuICAgIG1heFZhbHVlPzogbnVtYmVyO1xuICAgIG1pblVwcGVyY2FzZUNoYXJhY3RlcnM/OiBudW1iZXI7XG4gICAgbWF4VXBwZXJjYXNlQ2hhcmFjdGVycz86IG51bWJlcjtcbiAgICBtaW5OdW1lcmljYWxTeW1ib2xzPzogbnVtYmVyO1xuICAgIG1heE51bWVyaWNhbFN5bWJvbHM/OiBudW1iZXI7XG4gICAgaXNSZXF1aXJlZD86IGJvb2xlYW47XG4gICAgaXNWYWxpZD86IGJvb2xlYW47XG4gICAgaXNUb3VjaGVkPzogYm9vbGVhbjtcbiAgICBjdXN0b21SdWxlPzogQ3VzdG9tVmFsaWRhdGlvblJ1bGU8VCwgUz47XG4gICAgY29ubmVjdEZpZWxkcz86IHN0cmluZ1tdO1xufTtcblxudHlwZSBGb3JtRW50cnlTdGF0ZTxUIGV4dGVuZHMgRm9ybVZhbHVlVHlwZT4gPSB7XG4gICAgdmFsdWU6IFQ7XG4gICAgaXNWYWxpZDogYm9vbGVhbjtcbiAgICBpc1RvdWNoZWQ6IGJvb2xlYW47XG4gICAgcmVhZG9ubHkgdmFsaWRhdG9yczogVmFsaWRhdG9yW107XG4gICAgcmVhZG9ubHkgY29ubmVjdGVkRmllbGRzOiBzdHJpbmdbXTtcbn07XG5cbmludGVyZmFjZSBGb3JtUGF5bG9hZCBleHRlbmRzIFBpY2s8Rm9ybUVudHJ5U3RhdGU8YW55PiwgJ3ZhbHVlJz4ge1xuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgc3RhdGU/OiBGb3JtU3RhdGU8YW55Pjtcbn1cblxuZXhwb3J0IHR5cGUgRm9ybVN0YXRlQ29uc3RyYWludCA9IHsgW2tleTogc3RyaW5nXTogRm9ybVZhbHVlVHlwZSB9O1xuXG5leHBvcnQgdHlwZSBGb3JtVmFsdWVUeXBlID0gc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IEZpbGU7XG5cbmV4cG9ydCB0eXBlIEZvcm1TdGF0ZTxUIGV4dGVuZHMgRm9ybVN0YXRlQ29uc3RyYWludD4gPSB7XG4gICAgaW5wdXRzOiB7IFtLIGluIGtleW9mIFRdOiBGb3JtRW50cnlTdGF0ZTxUW0tdPiB9O1xuICAgIGlzVmFsaWQ6IGJvb2xlYW47XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0SW5wdXQ8VCBleHRlbmRzIEZvcm1WYWx1ZVR5cGUsIFMgZXh0ZW5kcyBGb3JtU3RhdGVDb25zdHJhaW50PihcbiAgICBpbml0aWFsVmFsdWU6IFQsXG4gICAgb3B0aW9ucz86IEdldElucHV0T3B0aW9uczxULCBTPlxuKTogRm9ybUVudHJ5U3RhdGU8VD4ge1xuICAgIGNvbnN0IHBhcnNlZE9wdGlvbnM6IFBpY2s8Rm9ybUVudHJ5U3RhdGU8VD4sICd2YWxpZGF0b3JzJyB8ICdpc1ZhbGlkJyB8ICdpc1RvdWNoZWQnIHwgJ2Nvbm5lY3RlZEZpZWxkcyc+ID0ge1xuICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgaXNUb3VjaGVkOiBmYWxzZSxcbiAgICAgICAgdmFsaWRhdG9yczogW10sXG4gICAgICAgIGNvbm5lY3RlZEZpZWxkczogb3B0aW9ucz8uY29ubmVjdEZpZWxkcyB8fCBbXVxuICAgIH07XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMob3B0aW9ucyk7XG4gICAgICAgIHBhcnNlZE9wdGlvbnMuaXNUb3VjaGVkID0gISFvcHRpb25zLmlzVG91Y2hlZDtcbiAgICAgICAgcGFyc2VkT3B0aW9ucy5pc1ZhbGlkID0gISFvcHRpb25zLmlzVmFsaWQ7XG4gICAgICAgIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICBpZiAoIShrZXkgaW4gWydpc1ZhbGlkJywgJ2lzVG91Y2hlZCcsICdjb25uZWN0ZWRGaWVsZHMnXSkpIHtcbiAgICAgICAgICAgICAgICBwYXJzZWRPcHRpb25zLnZhbGlkYXRvcnMucHVzaChnZXRWYWxpZGF0b3Ioa2V5IGFzIFZhbGlkYXRpb25UeXBlLCBvcHRpb25zW2tleV0gYXMgVCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgLi4ucGFyc2VkT3B0aW9ucyxcbiAgICAgICAgdmFsdWU6IGluaXRpYWxWYWx1ZVxuICAgIH07XG59XG5cbmNvbnN0IGhhbmRsZUNvbm5lY3RlZEZpZWxkcyA9IChzdGF0ZTogRm9ybVN0YXRlPGFueT4sIHRhcmdldElkOiBzdHJpbmcpOiB7IFtrZXk6IHN0cmluZ106IEZvcm1FbnRyeVN0YXRlPGFueT4gfSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbmV3SW5wdXRTdGF0ZSA9IHsgLi4uc3RhdGUuaW5wdXRzIH07XG4gICAgICAgIG5ld0lucHV0U3RhdGVbdGFyZ2V0SWRdLmNvbm5lY3RlZEZpZWxkcy5mb3JFYWNoKChjb25uZWN0ZWRGaWVsZElkKSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG5ld0lucHV0U3RhdGVbY29ubmVjdGVkRmllbGRJZF0gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgbmV3SW5wdXRTdGF0ZVtjb25uZWN0ZWRGaWVsZElkXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4ubmV3SW5wdXRTdGF0ZVtjb25uZWN0ZWRGaWVsZElkXSxcbiAgICAgICAgICAgICAgICAgICAgaXNWYWxpZDogdmFsaWRhdGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdJbnB1dFN0YXRlW2Nvbm5lY3RlZEZpZWxkSWRdLnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3SW5wdXRTdGF0ZVtjb25uZWN0ZWRGaWVsZElkXS52YWxpZGF0b3JzLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gbmV3SW5wdXRTdGF0ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgIHJldHVybiBzdGF0ZS5pbnB1dHM7XG4gICAgfVxufTtcblxuZnVuY3Rpb24gZm9ybVJlZHVjZXI8UyBleHRlbmRzIEZvcm1TdGF0ZTxhbnk+PihzdGF0ZTogUywgYWN0aW9uOiBSZWR1Y2VyQWN0aW9uKTogUyB7XG4gICAgY29uc3QgcGwgPSBhY3Rpb24ucGF5bG9hZDtcbiAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgIGNhc2UgRm9ybUFjdGlvbi5JTlBVVF9DSEFOR0U6XG4gICAgICAgICAgICBjb25zdCBuZXdTdGF0ZTogUyA9IHtcbiAgICAgICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgICAgICBpbnB1dHM6IHtcbiAgICAgICAgICAgICAgICAgICAgLi4uc3RhdGUuaW5wdXRzLFxuICAgICAgICAgICAgICAgICAgICBbcGwuaWRdOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5zdGF0ZS5pbnB1dHNbcGwuaWRdLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHBsLnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZDogdmFsaWRhdGUocGwudmFsdWUsIHN0YXRlLmlucHV0c1twbC5pZF0udmFsaWRhdG9ycywgc3RhdGUpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbmV3U3RhdGUuaW5wdXRzID0ge1xuICAgICAgICAgICAgICAgIC4uLm5ld1N0YXRlLmlucHV0cyxcbiAgICAgICAgICAgICAgICAuLi5oYW5kbGVDb25uZWN0ZWRGaWVsZHMoeyAuLi5uZXdTdGF0ZSB9LCBwbC5pZClcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBsZXQgaXNWYWxpZDogYm9vbGVhbiA9IHRydWU7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBuZXdTdGF0ZS5pbnB1dHMpIHtcbiAgICAgICAgICAgICAgICBpc1ZhbGlkID0gaXNWYWxpZCAmJiBuZXdTdGF0ZS5pbnB1dHNba2V5XS5pc1ZhbGlkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAuLi5uZXdTdGF0ZSxcbiAgICAgICAgICAgICAgICBpbnB1dHM6IHtcbiAgICAgICAgICAgICAgICAgICAgLi4ubmV3U3RhdGUuaW5wdXRzXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBpc1ZhbGlkXG4gICAgICAgICAgICB9O1xuICAgICAgICBjYXNlIEZvcm1BY3Rpb24uSU5QVVRfVE9VQ0g6XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIC4uLnN0YXRlLFxuICAgICAgICAgICAgICAgIGlucHV0czoge1xuICAgICAgICAgICAgICAgICAgICAuLi5zdGF0ZS5pbnB1dHMsXG4gICAgICAgICAgICAgICAgICAgIFtwbC5pZF06IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnN0YXRlLmlucHV0c1twbC5pZF0sXG4gICAgICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQ6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgRm9ybUFjdGlvbi5TRVRfRk9STTpcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGwuc3RhdGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgLi4uKHBsLnN0YXRlIGFzIFMpIH07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHVzZUZvcm1TdGF0ZTxTIGV4dGVuZHMgRm9ybVN0YXRlQ29uc3RyYWludCwgRSBleHRlbmRzIEZvcm1FbGVtZW50Q29uc3RyYWludCA9IEhUTUxJbnB1dEVsZW1lbnQ+KFxuICAgIGluaXRpYWxTdGF0ZTogRm9ybVN0YXRlPFM+XG4pOiB7XG4gICAgZm9ybVN0YXRlOiBGb3JtU3RhdGU8Uz47XG4gICAgb25Ub3VjaEhhbmRsZXI6IFJlYWN0LkZvY3VzRXZlbnRIYW5kbGVyPEU+O1xuICAgIG9uQ2hhbmdlSGFuZGxlcjogUmVhY3QuQ2hhbmdlRXZlbnRIYW5kbGVyPEU+O1xuICAgIHNldEZvcm1TdGF0ZTogKHN0YXRlOiBGb3JtU3RhdGU8Uz4pID0+IHZvaWQ7XG59IHtcbiAgICBjb25zdCBbZm9ybVN0YXRlLCBkaXNwYXRjaF0gPSB1c2VSZWR1Y2VyPFJlZHVjZXI8Rm9ybVN0YXRlPFM+LCBSZWR1Y2VyQWN0aW9uPj4oZm9ybVJlZHVjZXIsIHtcbiAgICAgICAgLi4uaW5pdGlhbFN0YXRlXG4gICAgfSk7XG5cbiAgICBjb25zdCBzZXRGb3JtU3RhdGUgPSB1c2VDYWxsYmFjaygoc3RhdGU6IEZvcm1TdGF0ZTxTPik6IHZvaWQgPT4ge1xuICAgICAgICBkaXNwYXRjaCh7IHR5cGU6IEZvcm1BY3Rpb24uU0VUX0ZPUk0sIHBheWxvYWQ6IHsgc3RhdGUsIHZhbHVlOiAnJywgaWQ6ICcnIH0gfSk7XG4gICAgfSwgW10pO1xuXG4gICAgY29uc3Qgb25Ub3VjaEhhbmRsZXI6IFJlYWN0LkZvY3VzRXZlbnRIYW5kbGVyPEU+ID0gdXNlQ2FsbGJhY2soKGV2ZW50KSA9PiB7XG4gICAgICAgIGRpc3BhdGNoKHsgdHlwZTogRm9ybUFjdGlvbi5JTlBVVF9UT1VDSCwgcGF5bG9hZDogeyBpZDogZXZlbnQudGFyZ2V0LmlkLCB2YWx1ZTogJycgfSB9KTtcbiAgICB9LCBbXSk7XG5cbiAgICBjb25zdCBvbkNoYW5nZUhhbmRsZXI6IFJlYWN0LkNoYW5nZUV2ZW50SGFuZGxlcjxFPiA9IHVzZUNhbGxiYWNrKChldmVudCkgPT4ge1xuICAgICAgICBkaXNwYXRjaCh7XG4gICAgICAgICAgICB0eXBlOiBGb3JtQWN0aW9uLklOUFVUX0NIQU5HRSxcbiAgICAgICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICAgICAgICBpZDogZXZlbnQudGFyZ2V0LmlkLFxuICAgICAgICAgICAgICAgIHZhbHVlOiBldmVudC50YXJnZXQudmFsdWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSwgW10pO1xuXG4gICAgcmV0dXJuIHsgZm9ybVN0YXRlLCBvbkNoYW5nZUhhbmRsZXIsIG9uVG91Y2hIYW5kbGVyLCBzZXRGb3JtU3RhdGUgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgdXNlRm9ybVN0YXRlO1xuIl19