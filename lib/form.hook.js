"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getInput = getInput;
exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = require("react");

var _form = require("./form.validation");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var FormAction;

(function (FormAction) {
  FormAction["INPUT_CHANGE"] = "INPUT_CHANGE";
  FormAction["INPUT_TOUCH"] = "INPUT_TOUCH";
  FormAction["SET_FORM"] = "SET_FORM";
})(FormAction || (FormAction = {}));

function getInput(initialValue, options) {
  var parsedOptions = {
    isValid: false,
    isTouched: false,
    validators: [],
    connectedFields: (options === null || options === void 0 ? void 0 : options.connectFields) || []
  };

  if (typeof options !== 'undefined') {
    var keys = Object.keys(options);
    parsedOptions.isTouched = !!options.isTouched;
    parsedOptions.isValid = !!options.isValid;
    keys.forEach(function (key) {
      if (!(key in ['isValid', 'isTouched', 'connectedFields'])) {
        parsedOptions.validators.push((0, _form.getValidator)(key, options[key]));
      }
    });
  }

  return _objectSpread(_objectSpread({}, parsedOptions), {}, {
    value: initialValue
  });
}

var handleConnectedFields = function handleConnectedFields(state, targetId) {
  try {
    var newInputState = _objectSpread({}, state.inputs);

    newInputState[targetId].connectedFields.forEach(function (connectedFieldId) {
      if (typeof newInputState[connectedFieldId] !== 'undefined') {
        newInputState[connectedFieldId] = _objectSpread(_objectSpread({}, newInputState[connectedFieldId]), {}, {
          isValid: (0, _form.validate)(newInputState[connectedFieldId].value, newInputState[connectedFieldId].validators, state)
        });
      }
    });
    return newInputState;
  } catch (err) {
    process.env.NODE_ENV !== 'production' && console.error(err);
    return state.inputs;
  }
};

function formReducer(state, action) {
  var pl = action.payload;

  switch (action.type) {
    case FormAction.INPUT_CHANGE:
      var newState = _objectSpread(_objectSpread({}, state), {}, {
        inputs: _objectSpread(_objectSpread({}, state.inputs), {}, (0, _defineProperty2["default"])({}, pl.id, _objectSpread(_objectSpread({}, state.inputs[pl.id]), {}, {
          value: pl.value,
          isValid: (0, _form.validate)(pl.value, state.inputs[pl.id].validators, state)
        })))
      });

      newState.inputs = _objectSpread(_objectSpread({}, newState.inputs), handleConnectedFields(_objectSpread({}, newState), pl.id));
      var isValid = true;

      for (var _key in newState.inputs) {
        isValid = isValid && newState.inputs[_key].isValid;
      }

      return _objectSpread(_objectSpread({}, newState), {}, {
        inputs: _objectSpread({}, newState.inputs),
        isValid: isValid
      });

    case FormAction.INPUT_TOUCH:
      return _objectSpread(_objectSpread({}, state), {}, {
        inputs: _objectSpread(_objectSpread({}, state.inputs), {}, (0, _defineProperty2["default"])({}, pl.id, _objectSpread(_objectSpread({}, state.inputs[pl.id]), {}, {
          isTouched: true
        })))
      });

    case FormAction.SET_FORM:
      if (typeof pl.state !== 'undefined') {
        return _objectSpread({}, pl.state);
      } else {
        return state;
      }

    default:
      return state;
  }
}

function useFormState(initialState) {
  var _useReducer = (0, _react.useReducer)(formReducer, _objectSpread({}, initialState)),
      _useReducer2 = (0, _slicedToArray2["default"])(_useReducer, 2),
      formState = _useReducer2[0],
      dispatch = _useReducer2[1];

  var setFormState = (0, _react.useCallback)(function (state) {
    dispatch({
      type: FormAction.SET_FORM,
      payload: {
        state: state,
        value: '',
        id: ''
      }
    });
  }, []);
  var onTouchHandler = (0, _react.useCallback)(function (event) {
    dispatch({
      type: FormAction.INPUT_TOUCH,
      payload: {
        id: event.target.id,
        value: ''
      }
    });
  }, []);
  var onChangeHandler = (0, _react.useCallback)(function (event) {
    dispatch({
      type: FormAction.INPUT_CHANGE,
      payload: {
        id: event.target.id,
        value: event.target.value
      }
    });
  }, []);
  return {
    formState: formState,
    onChangeHandler: onChangeHandler,
    onTouchHandler: onTouchHandler,
    setFormState: setFormState
  };
}

var _default = useFormState;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9mb3JtLmhvb2sudHMiXSwibmFtZXMiOlsiRm9ybUFjdGlvbiIsImdldElucHV0IiwiaW5pdGlhbFZhbHVlIiwib3B0aW9ucyIsInBhcnNlZE9wdGlvbnMiLCJpc1ZhbGlkIiwiaXNUb3VjaGVkIiwidmFsaWRhdG9ycyIsImNvbm5lY3RlZEZpZWxkcyIsImNvbm5lY3RGaWVsZHMiLCJrZXlzIiwiT2JqZWN0IiwiZm9yRWFjaCIsImtleSIsInB1c2giLCJ2YWx1ZSIsImhhbmRsZUNvbm5lY3RlZEZpZWxkcyIsInN0YXRlIiwidGFyZ2V0SWQiLCJuZXdJbnB1dFN0YXRlIiwiaW5wdXRzIiwiY29ubmVjdGVkRmllbGRJZCIsImVyciIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImNvbnNvbGUiLCJlcnJvciIsImZvcm1SZWR1Y2VyIiwiYWN0aW9uIiwicGwiLCJwYXlsb2FkIiwidHlwZSIsIklOUFVUX0NIQU5HRSIsIm5ld1N0YXRlIiwiaWQiLCJJTlBVVF9UT1VDSCIsIlNFVF9GT1JNIiwidXNlRm9ybVN0YXRlIiwiaW5pdGlhbFN0YXRlIiwiZm9ybVN0YXRlIiwiZGlzcGF0Y2giLCJzZXRGb3JtU3RhdGUiLCJvblRvdWNoSGFuZGxlciIsImV2ZW50IiwidGFyZ2V0Iiwib25DaGFuZ2VIYW5kbGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOzs7Ozs7SUFFS0EsVTs7V0FBQUEsVTtBQUFBQSxFQUFBQSxVO0FBQUFBLEVBQUFBLFU7QUFBQUEsRUFBQUEsVTtHQUFBQSxVLEtBQUFBLFU7O0FBaURFLFNBQVNDLFFBQVQsQ0FDSEMsWUFERyxFQUVIQyxPQUZHLEVBR2M7QUFDakIsTUFBTUMsYUFBa0csR0FBRztBQUN2R0MsSUFBQUEsT0FBTyxFQUFFLEtBRDhGO0FBRXZHQyxJQUFBQSxTQUFTLEVBQUUsS0FGNEY7QUFHdkdDLElBQUFBLFVBQVUsRUFBRSxFQUgyRjtBQUl2R0MsSUFBQUEsZUFBZSxFQUFFLENBQUFMLE9B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QUFLLEVBQUxBLEtBQUY7QUFBU0YsUUFBQUEsS0FBSyxFQUFFLEVBQWhCO0FBQW9Cb0IsUUFBQUEsRUFBRSxFQUFFO0FBQXhCO0FBQXRDLEtBQUQsQ0FBUjtBQUNILEdBRm9CLEVBRWxCLEVBRmtCLENBQXJCO0FBSUEsTUFBTVEsY0FBMEMsR0FBRyx3QkFBWSxVQUFDQyxLQUFELEVBQVc7QUFDdEVILElBQUFBLFFBQVEsQ0FBQztBQUFFVCxNQUFBQSxJQUFJLEVBQUVoQyxVQUFVLENBQUNvQyxXQUFuQjtBQUFnQ0wsTUFBQUEsT0FBTyxFQUFFO0FBQUVJLFFBQUFBLEVBQUUsRUFBRVMsS0FBSyxDQUFDQyxNQUFOLENBQWFWLEVBQW5CO0FBQXVCcEIsUUFBQUEsS0FBSyxFQUFFO0FBQTlCO0FBQXpDLEtBQUQsQ0FBUjtBQUNILEdBRmtELEVBRWhELEVBRmdELENBQW5EO0FBSUEsTUFBTStCLGVBQTRDLEdBQUcsd0JBQVksVUFBQ0YsS0FBRCxFQUFXO0FBQ3hFSCxJQUFBQSxRQUFRLENBQUM7QUFDTFQsTUFBQUEsSUFBSSxFQUFFaEMsVUFBVSxDQUFDaUMsWUFEWjtBQUVMRixNQUFBQSxPQUFPLEVBQUU7QUFDTEksUUFBQUEsRUFBRSxFQUFFUyxLQUFLLENBQUNDLE1BQU4sQ0FBYVYsRUFEWjtBQUVMcEIsUUFBQUEsS0FBSyxFQUFFNkIsS0FBSyxDQUFDQyxNQUFOLENBQWE5QjtBQUZmO0FBRkosS0FBRCxDQUFSO0FBT0gsR0FSb0QsRUFRbEQsRUFSa0QsQ0FBckQ7QUFVQSxTQUFPO0FBQUV5QixJQUFBQSxTQUFTLEVBQVRBLFNBQUY7QUFBYU0sSUFBQUEsZUFBZSxFQUFmQSxlQUFiO0FBQThCSCxJQUFBQSxjQUFjLEVBQWRBLGNBQTlCO0FBQThDRCxJQUFBQSxZQUFZLEVBQVpBO0FBQTlDLEdBQVA7QUFDSDs7ZUFFY0osWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVzZVJlZHVjZXIsIHVzZUNhbGxiYWNrLCBSZWR1Y2VyIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgeyBWYWxpZGF0b3IsIFZhbGlkYXRpb25UeXBlLCBDdXN0b21WYWxpZGF0aW9uUnVsZSwgZ2V0VmFsaWRhdG9yLCB2YWxpZGF0ZSB9IGZyb20gJy4vZm9ybS52YWxpZGF0aW9uJztcblxuZW51bSBGb3JtQWN0aW9uIHtcbiAgICBJTlBVVF9DSEFOR0UgPSAnSU5QVVRfQ0hBTkdFJyxcbiAgICBJTlBVVF9UT1VDSCA9ICdJTlBVVF9UT1VDSCcsXG4gICAgU0VUX0ZPUk0gPSAnU0VUX0ZPUk0nXG59XG5cbnR5cGUgRm9ybUVsZW1lbnRDb25zdHJhaW50ID0gSFRNTElucHV0RWxlbWVudCB8IEhUTUxUZXh0QXJlYUVsZW1lbnQgfCBIVE1MU2VsZWN0RWxlbWVudDtcblxudHlwZSBSZWR1Y2VyQWN0aW9uID0geyB0eXBlOiBGb3JtQWN0aW9uOyBwYXlsb2FkOiBGb3JtUGF5bG9hZCB9O1xuXG50eXBlIEdldElucHV0T3B0aW9uczxUIGV4dGVuZHMgRm9ybVZhbHVlVHlwZSwgUyBleHRlbmRzIEZvcm1TdGF0ZUNvbnN0cmFpbnQgPSBhbnk+ID0ge1xuICAgIFtrZXk6IHN0cmluZ106IFQgfCBudW1iZXIgfCBib29sZWFuIHwgQ3VzdG9tVmFsaWRhdGlvblJ1bGU8VCwgUz4gfCBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgICBtaW5MZW5ndGg/OiBudW1iZXI7XG4gICAgbWF4TGVuZ3RoPzogbnVtYmVyO1xuICAgIG1pblZhbHVlPzogbnVtYmVyO1xuICAgIG1heFZhbHVlPzogbnVtYmVyO1xuICAgIG1pblVwcGVyY2FzZUNoYXJhY3RlcnM/OiBudW1iZXI7XG4gICAgbWF4VXBwZXJjYXNlQ2hhcmFjdGVycz86IG51bWJlcjtcbiAgICBtaW5OdW1lcmljYWxTeW1ib2xzPzogbnVtYmVyOyAvLyBUT0RPXG4gICAgbWF4TnVtZXJpY2FsU3ltYm9scz86IG51bWJlcjsgLy8gVE9ET1xuICAgIGlzUmVxdWlyZWQ/OiBib29sZWFuO1xuICAgIGlzVmFsaWQ/OiBib29sZWFuO1xuICAgIGlzVG91Y2hlZD86IGJvb2xlYW47XG4gICAgY3VzdG9tUnVsZT86IEN1c3RvbVZhbGlkYXRpb25SdWxlPFQsIFM+O1xuICAgIGNvbm5lY3RGaWVsZHM/OiBzdHJpbmdbXTtcbn07XG5cbnR5cGUgRm9ybUVudHJ5U3RhdGU8VCBleHRlbmRzIEZvcm1WYWx1ZVR5cGU+ID0ge1xuICAgIHZhbHVlOiBUO1xuICAgIGlzVmFsaWQ6IGJvb2xlYW47XG4gICAgaXNUb3VjaGVkOiBib29sZWFuO1xuICAgIHJlYWRvbmx5IHZhbGlkYXRvcnM6IFZhbGlkYXRvcltdO1xuICAgIHJlYWRvbmx5IGNvbm5lY3RlZEZpZWxkczogc3RyaW5nW107XG59O1xuXG5pbnRlcmZhY2UgRm9ybVBheWxvYWQgZXh0ZW5kcyBQaWNrPEZvcm1FbnRyeVN0YXRlPGFueT4sICd2YWx1ZSc+IHtcbiAgICByZWFkb25seSBpZDogc3RyaW5nO1xuICAgIHJlYWRvbmx5IHN0YXRlPzogRm9ybVN0YXRlPGFueT47XG59XG5cbmV4cG9ydCB0eXBlIEZvcm1TdGF0ZUNvbnN0cmFpbnQgPSB7IFtrZXk6IHN0cmluZ106IEZvcm1WYWx1ZVR5cGUgfTtcblxuZXhwb3J0IHR5cGUgRm9ybVZhbHVlVHlwZSA9IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBGaWxlO1xuXG5leHBvcnQgdHlwZSBGb3JtU3RhdGU8VCBleHRlbmRzIEZvcm1TdGF0ZUNvbnN0cmFpbnQ+ID0ge1xuICAgIGlucHV0czogeyBbSyBpbiBrZXlvZiBUXTogRm9ybUVudHJ5U3RhdGU8VFtLXT4gfTtcbiAgICBpc1ZhbGlkOiBib29sZWFuO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldElucHV0PFQgZXh0ZW5kcyBGb3JtVmFsdWVUeXBlLCBTIGV4dGVuZHMgRm9ybVN0YXRlQ29uc3RyYWludD4oXG4gICAgaW5pdGlhbFZhbHVlOiBULFxuICAgIG9wdGlvbnM/OiBHZXRJbnB1dE9wdGlvbnM8VCwgUz5cbik6IEZvcm1FbnRyeVN0YXRlPFQ+IHtcbiAgICBjb25zdCBwYXJzZWRPcHRpb25zOiBQaWNrPEZvcm1FbnRyeVN0YXRlPFQ+LCAndmFsaWRhdG9ycycgfCAnaXNWYWxpZCcgfCAnaXNUb3VjaGVkJyB8ICdjb25uZWN0ZWRGaWVsZHMnPiA9IHtcbiAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgIGlzVG91Y2hlZDogZmFsc2UsXG4gICAgICAgIHZhbGlkYXRvcnM6IFtdLFxuICAgICAgICBjb25uZWN0ZWRGaWVsZHM6IG9wdGlvbnM/LmNvbm5lY3RGaWVsZHMgfHwgW11cbiAgICB9O1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG9wdGlvbnMpO1xuICAgICAgICBwYXJzZWRPcHRpb25zLmlzVG91Y2hlZCA9ICEhb3B0aW9ucy5pc1RvdWNoZWQ7XG4gICAgICAgIHBhcnNlZE9wdGlvbnMuaXNWYWxpZCA9ICEhb3B0aW9ucy5pc1ZhbGlkO1xuICAgICAgICBrZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgaWYgKCEoa2V5IGluIFsnaXNWYWxpZCcsICdpc1RvdWNoZWQnLCAnY29ubmVjdGVkRmllbGRzJ10pKSB7XG4gICAgICAgICAgICAgICAgcGFyc2VkT3B0aW9ucy52YWxpZGF0b3JzLnB1c2goZ2V0VmFsaWRhdG9yKGtleSBhcyBWYWxpZGF0aW9uVHlwZSwgb3B0aW9uc1trZXldIGFzIFQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIC4uLnBhcnNlZE9wdGlvbnMsXG4gICAgICAgIHZhbHVlOiBpbml0aWFsVmFsdWVcbiAgICB9O1xufVxuXG5jb25zdCBoYW5kbGVDb25uZWN0ZWRGaWVsZHMgPSAoc3RhdGU6IEZvcm1TdGF0ZTxhbnk+LCB0YXJnZXRJZDogc3RyaW5nKTogeyBba2V5OiBzdHJpbmddOiBGb3JtRW50cnlTdGF0ZTxhbnk+IH0gPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IG5ld0lucHV0U3RhdGUgPSB7IC4uLnN0YXRlLmlucHV0cyB9O1xuICAgICAgICBuZXdJbnB1dFN0YXRlW3RhcmdldElkXS5jb25uZWN0ZWRGaWVsZHMuZm9yRWFjaCgoY29ubmVjdGVkRmllbGRJZCkgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdJbnB1dFN0YXRlW2Nvbm5lY3RlZEZpZWxkSWRdICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIG5ld0lucHV0U3RhdGVbY29ubmVjdGVkRmllbGRJZF0gPSB7XG4gICAgICAgICAgICAgICAgICAgIC4uLm5ld0lucHV0U3RhdGVbY29ubmVjdGVkRmllbGRJZF0sXG4gICAgICAgICAgICAgICAgICAgIGlzVmFsaWQ6IHZhbGlkYXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3SW5wdXRTdGF0ZVtjb25uZWN0ZWRGaWVsZElkXS52YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0lucHV0U3RhdGVbY29ubmVjdGVkRmllbGRJZF0udmFsaWRhdG9ycyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG5ld0lucHV0U3RhdGU7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICByZXR1cm4gc3RhdGUuaW5wdXRzO1xuICAgIH1cbn07XG5cbmZ1bmN0aW9uIGZvcm1SZWR1Y2VyPFMgZXh0ZW5kcyBGb3JtU3RhdGU8YW55Pj4oc3RhdGU6IFMsIGFjdGlvbjogUmVkdWNlckFjdGlvbik6IFMge1xuICAgIGNvbnN0IHBsID0gYWN0aW9uLnBheWxvYWQ7XG4gICAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgICAgICBjYXNlIEZvcm1BY3Rpb24uSU5QVVRfQ0hBTkdFOlxuICAgICAgICAgICAgY29uc3QgbmV3U3RhdGU6IFMgPSB7XG4gICAgICAgICAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgICAgICAgICAgaW5wdXRzOiB7XG4gICAgICAgICAgICAgICAgICAgIC4uLnN0YXRlLmlucHV0cyxcbiAgICAgICAgICAgICAgICAgICAgW3BsLmlkXToge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uc3RhdGUuaW5wdXRzW3BsLmlkXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwbC52YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQ6IHZhbGlkYXRlKHBsLnZhbHVlLCBzdGF0ZS5pbnB1dHNbcGwuaWRdLnZhbGlkYXRvcnMsIHN0YXRlKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG5ld1N0YXRlLmlucHV0cyA9IHtcbiAgICAgICAgICAgICAgICAuLi5uZXdTdGF0ZS5pbnB1dHMsXG4gICAgICAgICAgICAgICAgLi4uaGFuZGxlQ29ubmVjdGVkRmllbGRzKHsgLi4ubmV3U3RhdGUgfSwgcGwuaWQpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbGV0IGlzVmFsaWQ6IGJvb2xlYW4gPSB0cnVlO1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gbmV3U3RhdGUuaW5wdXRzKSB7XG4gICAgICAgICAgICAgICAgaXNWYWxpZCA9IGlzVmFsaWQgJiYgbmV3U3RhdGUuaW5wdXRzW2tleV0uaXNWYWxpZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgLi4ubmV3U3RhdGUsXG4gICAgICAgICAgICAgICAgaW5wdXRzOiB7XG4gICAgICAgICAgICAgICAgICAgIC4uLm5ld1N0YXRlLmlucHV0c1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaXNWYWxpZFxuICAgICAgICAgICAgfTtcbiAgICAgICAgY2FzZSBGb3JtQWN0aW9uLklOUFVUX1RPVUNIOlxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgICAgICBpbnB1dHM6IHtcbiAgICAgICAgICAgICAgICAgICAgLi4uc3RhdGUuaW5wdXRzLFxuICAgICAgICAgICAgICAgICAgICBbcGwuaWRdOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5zdGF0ZS5pbnB1dHNbcGwuaWRdLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBjYXNlIEZvcm1BY3Rpb24uU0VUX0ZPUk06XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBsLnN0YXRlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLihwbC5zdGF0ZSBhcyBTKSB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgfVxufVxuXG5mdW5jdGlvbiB1c2VGb3JtU3RhdGU8UyBleHRlbmRzIEZvcm1TdGF0ZUNvbnN0cmFpbnQsIEUgZXh0ZW5kcyBGb3JtRWxlbWVudENvbnN0cmFpbnQgPSBIVE1MSW5wdXRFbGVtZW50PihcbiAgICBpbml0aWFsU3RhdGU6IEZvcm1TdGF0ZTxTPlxuKToge1xuICAgIGZvcm1TdGF0ZTogRm9ybVN0YXRlPFM+O1xuICAgIG9uVG91Y2hIYW5kbGVyOiBSZWFjdC5Gb2N1c0V2ZW50SGFuZGxlcjxFPjtcbiAgICBvbkNoYW5nZUhhbmRsZXI6IFJlYWN0LkNoYW5nZUV2ZW50SGFuZGxlcjxFPjtcbiAgICBzZXRGb3JtU3RhdGU6IChzdGF0ZTogRm9ybVN0YXRlPFM+KSA9PiB2b2lkO1xufSB7XG4gICAgY29uc3QgW2Zvcm1TdGF0ZSwgZGlzcGF0Y2hdID0gdXNlUmVkdWNlcjxSZWR1Y2VyPEZvcm1TdGF0ZTxTPiwgUmVkdWNlckFjdGlvbj4+KGZvcm1SZWR1Y2VyLCB7XG4gICAgICAgIC4uLmluaXRpYWxTdGF0ZVxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2V0Rm9ybVN0YXRlID0gdXNlQ2FsbGJhY2soKHN0YXRlOiBGb3JtU3RhdGU8Uz4pOiB2b2lkID0+IHtcbiAgICAgICAgZGlzcGF0Y2goeyB0eXBlOiBGb3JtQWN0aW9uLlNFVF9GT1JNLCBwYXlsb2FkOiB7IHN0YXRlLCB2YWx1ZTogJycsIGlkOiAnJyB9IH0pO1xuICAgIH0sIFtdKTtcblxuICAgIGNvbnN0IG9uVG91Y2hIYW5kbGVyOiBSZWFjdC5Gb2N1c0V2ZW50SGFuZGxlcjxFPiA9IHVzZUNhbGxiYWNrKChldmVudCkgPT4ge1xuICAgICAgICBkaXNwYXRjaCh7IHR5cGU6IEZvcm1BY3Rpb24uSU5QVVRfVE9VQ0gsIHBheWxvYWQ6IHsgaWQ6IGV2ZW50LnRhcmdldC5pZCwgdmFsdWU6ICcnIH0gfSk7XG4gICAgfSwgW10pO1xuXG4gICAgY29uc3Qgb25DaGFuZ2VIYW5kbGVyOiBSZWFjdC5DaGFuZ2VFdmVudEhhbmRsZXI8RT4gPSB1c2VDYWxsYmFjaygoZXZlbnQpID0+IHtcbiAgICAgICAgZGlzcGF0Y2goe1xuICAgICAgICAgICAgdHlwZTogRm9ybUFjdGlvbi5JTlBVVF9DSEFOR0UsXG4gICAgICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgICAgICAgaWQ6IGV2ZW50LnRhcmdldC5pZCxcbiAgICAgICAgICAgICAgICB2YWx1ZTogZXZlbnQudGFyZ2V0LnZhbHVlXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0sIFtdKTtcblxuICAgIHJldHVybiB7IGZvcm1TdGF0ZSwgb25DaGFuZ2VIYW5kbGVyLCBvblRvdWNoSGFuZGxlciwgc2V0Rm9ybVN0YXRlIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IHVzZUZvcm1TdGF0ZTtcbiJdfQ==