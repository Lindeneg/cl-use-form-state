"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getInput = getInput;
exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = require("react");

var _form = require("./form.validation");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var FormAction;

(function (FormAction) {
  FormAction["INPUT_CHANGE"] = "INPUT_CHANGE";
  FormAction["INPUT_TOUCH"] = "INPUT_TOUCH";
  FormAction["SET_FORM"] = "SET_FORM";
})(FormAction || (FormAction = {}));

function getInput(initialValue, options) {
  var parsedOptions = {
    isValid: false,
    isTouched: false,
    validators: [],
    connectedFields: (options === null || options === void 0 ? void 0 : options.connectFields) || []
  };

  if (typeof options !== 'undefined') {
    var keys = Object.keys(options);
    parsedOptions.isTouched = !!options.isTouched;
    parsedOptions.isValid = !!options.isValid;
    keys.forEach(function (key) {
      if (!['isValid', 'isTouched', 'connectedFields'].includes(key)) {
        parsedOptions.validators.push((0, _form.getValidator)(key, options[key]));
      }
    });
  }

  return _objectSpread(_objectSpread({}, parsedOptions), {}, {
    value: initialValue
  });
}

var handleConnectedFields = function handleConnectedFields(state, targetId) {
  try {
    var newInputState = _objectSpread({}, state.inputs);

    newInputState[targetId].connectedFields.forEach(function (connectedFieldId) {
      if (typeof newInputState[connectedFieldId] !== 'undefined') {
        newInputState[connectedFieldId] = _objectSpread(_objectSpread({}, newInputState[connectedFieldId]), {}, {
          isValid: (0, _form.validate)(newInputState[connectedFieldId].value, newInputState[connectedFieldId].validators, state)
        });
      }
    });
    return newInputState;
  } catch (err) {
    process.env.NODE_ENV !== 'production' && console.error(err);
    return state.inputs;
  }
};

function formReducer(state, action) {
  var pl = action.payload;

  switch (action.type) {
    case FormAction.INPUT_CHANGE:
      var newState = _objectSpread(_objectSpread({}, state), {}, {
        inputs: _objectSpread(_objectSpread({}, state.inputs), {}, (0, _defineProperty2["default"])({}, pl.id, _objectSpread(_objectSpread({}, state.inputs[pl.id]), {}, {
          value: pl.value,
          isValid: (0, _form.validate)(pl.value, state.inputs[pl.id].validators, state)
        })))
      });

      newState.inputs = _objectSpread(_objectSpread({}, newState.inputs), handleConnectedFields(_objectSpread({}, newState), pl.id));
      var isValid = true;

      for (var _key in newState.inputs) {
        isValid = isValid && newState.inputs[_key].isValid;
      }

      return _objectSpread(_objectSpread({}, newState), {}, {
        inputs: _objectSpread({}, newState.inputs),
        isValid: isValid
      });

    case FormAction.INPUT_TOUCH:
      return _objectSpread(_objectSpread({}, state), {}, {
        inputs: _objectSpread(_objectSpread({}, state.inputs), {}, (0, _defineProperty2["default"])({}, pl.id, _objectSpread(_objectSpread({}, state.inputs[pl.id]), {}, {
          isTouched: true
        })))
      });

    case FormAction.SET_FORM:
      if (typeof pl.state !== 'undefined') {
        return _objectSpread({}, pl.state);
      } else {
        return state;
      }

    default:
      return state;
  }
}

function useFormState(initialState) {
  var _useReducer = (0, _react.useReducer)(formReducer, _objectSpread({}, initialState)),
      _useReducer2 = (0, _slicedToArray2["default"])(_useReducer, 2),
      formState = _useReducer2[0],
      dispatch = _useReducer2[1];

  var setFormState = (0, _react.useCallback)(function (state) {
    dispatch({
      type: FormAction.SET_FORM,
      payload: {
        state: state,
        value: '',
        id: ''
      }
    });
  }, []);
  var onTouchHandler = (0, _react.useCallback)(function (event) {
    dispatch({
      type: FormAction.INPUT_TOUCH,
      payload: {
        id: event.target.id,
        value: ''
      }
    });
  }, []);
  var onChangeHandler = (0, _react.useCallback)(function (event) {
    dispatch({
      type: FormAction.INPUT_CHANGE,
      payload: {
        id: event.target.id,
        value: event.target.value
      }
    });
  }, []);
  return {
    formState: formState,
    onChangeHandler: onChangeHandler,
    onTouchHandler: onTouchHandler,
    setFormState: setFormState
  };
}

var _default = useFormState;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9mb3JtLmhvb2sudHMiXSwibmFtZXMiOlsiRm9ybUFjdGlvbiIsImdldElucHV0IiwiaW5pdGlhbFZhbHVlIiwib3B0aW9ucyIsInBhcnNlZE9wdGlvbnMiLCJpc1ZhbGlkIiwiaXNUb3VjaGVkIiwidmFsaWRhdG9ycyIsImNvbm5lY3RlZEZpZWxkcyIsImNvbm5lY3RGaWVsZHMiLCJrZXlzIiwiT2JqZWN0IiwiZm9yRWFjaCIsImtleSIsImluY2x1ZGVzIiwicHVzaCIsInZhbHVlIiwiaGFuZGxlQ29ubmVjdGVkRmllbGRzIiwic3RhdGUiLCJ0YXJnZXRJZCIsIm5ld0lucHV0U3RhdGUiLCJpbnB1dHMiLCJjb25uZWN0ZWRGaWVsZElkIiwiZXJyIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiY29uc29sZSIsImVycm9yIiwiZm9ybVJlZHVjZXIiLCJhY3Rpb24iLCJwbCIsInBheWxvYWQiLCJ0eXBlIiwiSU5QVVRfQ0hBTkdFIiwibmV3U3RhdGUiLCJpZCIsIklOUFVUX1RPVUNIIiwiU0VUX0ZPUk0iLCJ1c2VGb3JtU3RhdGUiLCJpbml0aWFsU3RhdGUiLCJmb3JtU3RhdGUiLCJkaXNwYXRjaCIsInNldEZvcm1TdGF0ZSIsIm9uVG91Y2hIYW5kbGVyIiwiZXZlbnQiLCJ0YXJnZXQiLCJvbkNoYW5nZUhhbmRsZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBRUE7Ozs7OztJQUVLQSxVOztXQUFBQSxVO0FBQUFBLEVBQUFBLFU7QUFBQUEsRUFBQUEsVTtBQUFBQSxFQUFBQSxVO0dBQUFBLFUsS0FBQUEsVTs7QUFpREUsU0FBU0MsUUFBVCxDQUNIQyxZQURHLEVBRUhDLE9BRkcsRUFHYztBQUNqQixNQUFNQyxhQUFrRyxHQUFHO0FBQ3ZHQyxJQUFBQSxPQUFPLEVBQUUsS0FEOEY7QUFFdkdDLElBQUFBLFNBQVMsRUFBRSxLQUY0RjtBQUd2R0MsSUFBQUEsVUFBVSxFQUFFLEVBSDJGO0FBSXZHQyxJQUFBQSxlQUFlLEVB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XG5cbmltcG9ydCB7IFZhbGlkYXRvciwgVmFsaWRhdGlvblR5cGUsIEN1c3RvbVZhbGlkYXRpb25SdWxlLCBnZXRWYWxpZGF0b3IsIHZhbGlkYXRlIH0gZnJvbSAnLi9mb3JtLnZhbGlkYXRpb24nO1xuXG5lbnVtIEZvcm1BY3Rpb24ge1xuICAgIElOUFVUX0NIQU5HRSA9ICdJTlBVVF9DSEFOR0UnLFxuICAgIElOUFVUX1RPVUNIID0gJ0lOUFVUX1RPVUNIJyxcbiAgICBTRVRfRk9STSA9ICdTRVRfRk9STSdcbn1cblxudHlwZSBGb3JtRWxlbWVudENvbnN0cmFpbnQgPSBIVE1MSW5wdXRFbGVtZW50IHwgSFRNTFRleHRBcmVhRWxlbWVudCB8IEhUTUxTZWxlY3RFbGVtZW50O1xuXG50eXBlIFJlZHVjZXJBY3Rpb24gPSB7IHR5cGU6IEZvcm1BY3Rpb247IHBheWxvYWQ6IEZvcm1QYXlsb2FkIH07XG5cbnR5cGUgR2V0SW5wdXRPcHRpb25zPFQgZXh0ZW5kcyBGb3JtVmFsdWVUeXBlLCBTIGV4dGVuZHMgRm9ybVN0YXRlQ29uc3RyYWludCA9IGFueT4gPSB7XG4gICAgW2tleTogc3RyaW5nXTogVCB8IG51bWJlciB8IGJvb2xlYW4gfCBDdXN0b21WYWxpZGF0aW9uUnVsZTxULCBTPiB8IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuICAgIG1pbkxlbmd0aD86IG51bWJlcjtcbiAgICBtYXhMZW5ndGg/OiBudW1iZXI7XG4gICAgbWluVmFsdWU/OiBudW1iZXI7XG4gICAgbWF4VmFsdWU/OiBudW1iZXI7XG4gICAgbWluVXBwZXJjYXNlQ2hhcmFjdGVycz86IG51bWJlcjtcbiAgICBtYXhVcHBlcmNhc2VDaGFyYWN0ZXJzPzogbnVtYmVyO1xuICAgIG1pbk51bWVyaWNhbFN5bWJvbHM/OiBudW1iZXI7XG4gICAgbWF4TnVtZXJpY2FsU3ltYm9scz86IG51bWJlcjtcbiAgICBpc1JlcXVpcmVkPzogYm9vbGVhbjtcbiAgICBpc1ZhbGlkPzogYm9vbGVhbjtcbiAgICBpc1RvdWNoZWQ/OiBib29sZWFuO1xuICAgIGN1c3RvbVJ1bGU/OiBDdXN0b21WYWxpZGF0aW9uUnVsZTxULCBTPjtcbiAgICBjb25uZWN0RmllbGRzPzogc3RyaW5nW107XG59O1xuXG50eXBlIEZvcm1FbnRyeVN0YXRlPFQgZXh0ZW5kcyBGb3JtVmFsdWVUeXBlPiA9IHtcbiAgICB2YWx1ZTogVDtcbiAgICBpc1ZhbGlkOiBib29sZWFuO1xuICAgIGlzVG91Y2hlZDogYm9vbGVhbjtcbiAgICByZWFkb25seSB2YWxpZGF0b3JzOiBWYWxpZGF0b3JbXTtcbiAgICByZWFkb25seSBjb25uZWN0ZWRGaWVsZHM6IHN0cmluZ1tdO1xufTtcblxuaW50ZXJmYWNlIEZvcm1QYXlsb2FkIGV4dGVuZHMgUGljazxGb3JtRW50cnlTdGF0ZTxhbnk+LCAndmFsdWUnPiB7XG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcbiAgICByZWFkb25seSBzdGF0ZT86IEZvcm1TdGF0ZTxhbnk+O1xufVxuXG5leHBvcnQgdHlwZSBGb3JtU3RhdGVDb25zdHJhaW50ID0geyBba2V5OiBzdHJpbmddOiBGb3JtVmFsdWVUeXBlIH07XG5cbmV4cG9ydCB0eXBlIEZvcm1WYWx1ZVR5cGUgPSBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgRmlsZTtcblxuZXhwb3J0IHR5cGUgRm9ybVN0YXRlPFQgZXh0ZW5kcyBGb3JtU3RhdGVDb25zdHJhaW50PiA9IHtcbiAgICBpbnB1dHM6IHsgW0sgaW4ga2V5b2YgVF06IEZvcm1FbnRyeVN0YXRlPFRbS10+IH07XG4gICAgaXNWYWxpZDogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbnB1dDxUIGV4dGVuZHMgRm9ybVZhbHVlVHlwZSwgUyBleHRlbmRzIEZvcm1TdGF0ZUNvbnN0cmFpbnQgPSBhbnk+KFxuICAgIGluaXRpYWxWYWx1ZTogVCxcbiAgICBvcHRpb25zPzogR2V0SW5wdXRPcHRpb25zPFQsIFM+XG4pOiBGb3JtRW50cnlTdGF0ZTxUPiB7XG4gICAgY29uc3QgcGFyc2VkT3B0aW9uczogUGljazxGb3JtRW50cnlTdGF0ZTxUPiwgJ3ZhbGlkYXRvcnMnIHwgJ2lzVmFsaWQnIHwgJ2lzVG91Y2hlZCcgfCAnY29ubmVjdGVkRmllbGRzJz4gPSB7XG4gICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICBpc1RvdWNoZWQ6IGZhbHNlLFxuICAgICAgICB2YWxpZGF0b3JzOiBbXSxcbiAgICAgICAgY29ubmVjdGVkRmllbGRzOiBvcHRpb25zPy5jb25uZWN0RmllbGRzIHx8IFtdXG4gICAgfTtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhvcHRpb25zKTtcbiAgICAgICAgcGFyc2VkT3B0aW9ucy5pc1RvdWNoZWQgPSAhIW9wdGlvbnMuaXNUb3VjaGVkO1xuICAgICAgICBwYXJzZWRPcHRpb25zLmlzVmFsaWQgPSAhIW9wdGlvbnMuaXNWYWxpZDtcbiAgICAgICAga2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgIGlmICghWydpc1ZhbGlkJywgJ2lzVG91Y2hlZCcsICdjb25uZWN0ZWRGaWVsZHMnXS5pbmNsdWRlcyhrZXkpKSB7XG4gICAgICAgICAgICAgICAgcGFyc2VkT3B0aW9ucy52YWxpZGF0b3JzLnB1c2goZ2V0VmFsaWRhdG9yKGtleSBhcyBWYWxpZGF0aW9uVHlwZSwgb3B0aW9uc1trZXldIGFzIFQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIC4uLnBhcnNlZE9wdGlvbnMsXG4gICAgICAgIHZhbHVlOiBpbml0aWFsVmFsdWVcbiAgICB9O1xufVxuXG5jb25zdCBoYW5kbGVDb25uZWN0ZWRGaWVsZHMgPSAoc3RhdGU6IEZvcm1TdGF0ZTxhbnk+LCB0YXJnZXRJZDogc3RyaW5nKTogeyBba2V5OiBzdHJpbmddOiBGb3JtRW50cnlTdGF0ZTxhbnk+IH0gPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IG5ld0lucHV0U3RhdGUgPSB7IC4uLnN0YXRlLmlucHV0cyB9O1xuICAgICAgICBuZXdJbnB1dFN0YXRlW3RhcmdldElkXS5jb25uZWN0ZWRGaWVsZHMuZm9yRWFjaCgoY29ubmVjdGVkRmllbGRJZCkgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdJbnB1dFN0YXRlW2Nvbm5lY3RlZEZpZWxkSWRdICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIG5ld0lucHV0U3RhdGVbY29ubmVjdGVkRmllbGRJZF0gPSB7XG4gICAgICAgICAgICAgICAgICAgIC4uLm5ld0lucHV0U3RhdGVbY29ubmVjdGVkRmllbGRJZF0sXG4gICAgICAgICAgICAgICAgICAgIGlzVmFsaWQ6IHZhbGlkYXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3SW5wdXRTdGF0ZVtjb25uZWN0ZWRGaWVsZElkXS52YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0lucHV0U3RhdGVbY29ubmVjdGVkRmllbGRJZF0udmFsaWRhdG9ycyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG5ld0lucHV0U3RhdGU7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICByZXR1cm4gc3RhdGUuaW5wdXRzO1xuICAgIH1cbn07XG5cbmZ1bmN0aW9uIGZvcm1SZWR1Y2VyPFMgZXh0ZW5kcyBGb3JtU3RhdGU8YW55Pj4oc3RhdGU6IFMsIGFjdGlvbjogUmVkdWNlckFjdGlvbik6IFMge1xuICAgIGNvbnN0IHBsID0gYWN0aW9uLnBheWxvYWQ7XG4gICAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgICAgICBjYXNlIEZvcm1BY3Rpb24uSU5QVVRfQ0hBTkdFOlxuICAgICAgICAgICAgY29uc3QgbmV3U3RhdGU6IFMgPSB7XG4gICAgICAgICAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgICAgICAgICAgaW5wdXRzOiB7XG4gICAgICAgICAgICAgICAgICAgIC4uLnN0YXRlLmlucHV0cyxcbiAgICAgICAgICAgICAgICAgICAgW3BsLmlkXToge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uc3RhdGUuaW5wdXRzW3BsLmlkXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwbC52YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQ6IHZhbGlkYXRlKHBsLnZhbHVlLCBzdGF0ZS5pbnB1dHNbcGwuaWRdLnZhbGlkYXRvcnMsIHN0YXRlKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG5ld1N0YXRlLmlucHV0cyA9IHtcbiAgICAgICAgICAgICAgICAuLi5uZXdTdGF0ZS5pbnB1dHMsXG4gICAgICAgICAgICAgICAgLi4uaGFuZGxlQ29ubmVjdGVkRmllbGRzKHsgLi4ubmV3U3RhdGUgfSwgcGwuaWQpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbGV0IGlzVmFsaWQ6IGJvb2xlYW4gPSB0cnVlO1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gbmV3U3RhdGUuaW5wdXRzKSB7XG4gICAgICAgICAgICAgICAgaXNWYWxpZCA9IGlzVmFsaWQgJiYgbmV3U3RhdGUuaW5wdXRzW2tleV0uaXNWYWxpZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgLi4ubmV3U3RhdGUsXG4gICAgICAgICAgICAgICAgaW5wdXRzOiB7XG4gICAgICAgICAgICAgICAgICAgIC4uLm5ld1N0YXRlLmlucHV0c1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaXNWYWxpZFxuICAgICAgICAgICAgfTtcbiAgICAgICAgY2FzZSBGb3JtQWN0aW9uLklOUFVUX1RPVUNIOlxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgICAgICBpbnB1dHM6IHtcbiAgICAgICAgICAgICAgICAgICAgLi4uc3RhdGUuaW5wdXRzLFxuICAgICAgICAgICAgICAgICAgICBbcGwuaWRdOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5zdGF0ZS5pbnB1dHNbcGwuaWRdLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBjYXNlIEZvcm1BY3Rpb24uU0VUX0ZPUk06XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBsLnN0YXRlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLihwbC5zdGF0ZSBhcyBTKSB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgfVxufVxuXG5mdW5jdGlvbiB1c2VGb3JtU3RhdGU8UyBleHRlbmRzIEZvcm1TdGF0ZUNvbnN0cmFpbnQsIEUgZXh0ZW5kcyBGb3JtRWxlbWVudENvbnN0cmFpbnQgPSBIVE1MSW5wdXRFbGVtZW50PihcbiAgICBpbml0aWFsU3RhdGU6IEZvcm1TdGF0ZTxTPlxuKToge1xuICAgIGZvcm1TdGF0ZTogRm9ybVN0YXRlPFM+O1xuICAgIG9uVG91Y2hIYW5kbGVyOiBSZWFjdC5Gb2N1c0V2ZW50SGFuZGxlcjxFPjtcbiAgICBvbkNoYW5nZUhhbmRsZXI6IFJlYWN0LkNoYW5nZUV2ZW50SGFuZGxlcjxFPjtcbiAgICBzZXRGb3JtU3RhdGU6IChzdGF0ZTogRm9ybVN0YXRlPFM+KSA9PiB2b2lkO1xufSB7XG4gICAgY29uc3QgW2Zvcm1TdGF0ZSwgZGlzcGF0Y2hdID0gdXNlUmVkdWNlcjxSZWR1Y2VyPEZvcm1TdGF0ZTxTPiwgUmVkdWNlckFjdGlvbj4+KGZvcm1SZWR1Y2VyLCB7XG4gICAgICAgIC4uLmluaXRpYWxTdGF0ZVxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2V0Rm9ybVN0YXRlID0gdXNlQ2FsbGJhY2soKHN0YXRlOiBGb3JtU3RhdGU8Uz4pOiB2b2lkID0+IHtcbiAgICAgICAgZGlzcGF0Y2goeyB0eXBlOiBGb3JtQWN0aW9uLlNFVF9GT1JNLCBwYXlsb2FkOiB7IHN0YXRlLCB2YWx1ZTogJycsIGlkOiAnJyB9IH0pO1xuICAgIH0sIFtdKTtcblxuICAgIGNvbnN0IG9uVG91Y2hIYW5kbGVyOiBSZWFjdC5Gb2N1c0V2ZW50SGFuZGxlcjxFPiA9IHVzZUNhbGxiYWNrKChldmVudCkgPT4ge1xuICAgICAgICBkaXNwYXRjaCh7IHR5cGU6IEZvcm1BY3Rpb24uSU5QVVRfVE9VQ0gsIHBheWxvYWQ6IHsgaWQ6IGV2ZW50LnRhcmdldC5pZCwgdmFsdWU6ICcnIH0gfSk7XG4gICAgfSwgW10pO1xuXG4gICAgY29uc3Qgb25DaGFuZ2VIYW5kbGVyOiBSZWFjdC5DaGFuZ2VFdmVudEhhbmRsZXI8RT4gPSB1c2VDYWxsYmFjaygoZXZlbnQpID0+IHtcbiAgICAgICAgZGlzcGF0Y2goe1xuICAgICAgICAgICAgdHlwZTogRm9ybUFjdGlvbi5JTlBVVF9DSEFOR0UsXG4gICAgICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgICAgICAgaWQ6IGV2ZW50LnRhcmdldC5pZCxcbiAgICAgICAgICAgICAgICB2YWx1ZTogZXZlbnQudGFyZ2V0LnZhbHVlXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0sIFtdKTtcblxuICAgIHJldHVybiB7IGZvcm1TdGF0ZSwgb25DaGFuZ2VIYW5kbGVyLCBvblRvdWNoSGFuZGxlciwgc2V0Rm9ybVN0YXRlIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IHVzZUZvcm1TdGF0ZTtcbiJdfQ==